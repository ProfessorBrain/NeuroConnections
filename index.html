<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ðŸ§  NeuroConnections</title>
<style>
  :root{
    --bg:#f8fafc; --text:#0f172a; --muted:#64748b; --card:#ffffff; --border:#d1d5db;
    --tile:#ffffff; --tile-hover:#f8fafc; --tile-selected:#e0e7ff; --tile-selected-border:#a5b4fc;
    --ok:#16a34a; --warn:#d97706; --err:#dc2626;
    --c1:#B388EB; --c2:#5DD0C2; --c3:#F2C14E; --c4:#F78C6C;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; line-height:1.25;}
  .wrap{width:min(520px,92vw); margin:0 auto; padding:40px 0 24px; position:relative;}
  h1{margin:0 0 6px; text-align:center; font-weight:900; font-size:28px; letter-spacing:-0.01em}
  h2{margin:0; text-align:center; font-weight:700; font-size:18px}
  .grid{margin-top:24px; display:grid; grid-template-columns:repeat(4,1fr); gap:10px; justify-items:center;}
  .tile{width:112px; height:112px; border-radius:10px; border:1px solid var(--border); background:var(--tile);
        display:flex; align-items:center; justify-content:center; font-weight:800; font-size:17px; text-align:center; cursor:pointer;
        transition:background .15s ease, border-color .15s ease, transform .02s ease-in-out; user-select:none;}
  .tile:hover{ background:var(--tile-hover); }
  .tile.selected{ background:var(--tile-selected); border-color:var(--tile-selected-border); outline:2px solid var(--tile-selected-border); }
  .solved-card{ grid-column:1/-1; width:100%; border-radius:10px; border:1px solid var(--border); background:var(--card); padding:12px; display:flex; align-items:center; gap:10px; }
  .badge{ font-weight:900; padding:6px 10px; border-radius:999px; color:#0b0e12; font-size:12px; }
  .toast{ position:absolute; left:50%; transform:translateX(-50%); top:64px; z-index:20; pointer-events:none; font-weight:700; font-size:14px; border-radius:8px; padding:8px 10px; display:none; border:1px solid transparent; }
  .toast.show{display:block} .toast.ok{ background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.35)}
  .toast.warn{ background:rgba(217,119,6,.10); border-color:rgba(217,119,6,.35)} .toast.err{ background:rgba(220,38,38,.10); border-color:rgba(220,38,38,.35)}
  .controls{ margin-top:18px; display:flex; align-items:center; justify-content:center; gap:10px; }
  .btn{ border-radius:10px; border:1px solid var(--border); background:#fff; color:var(--text); padding:14px 20px; font-weight:900; letter-spacing:.06em; text-transform:uppercase; font-size:13px; cursor:pointer; }
  .btn:hover{ background:#f8fafc; }
  footer{ margin-top:14px; text-align:center; color:#94a3b8; font-size:12px; user-select:none}
  .skeleton{ width:112px; height:112px; border-radius:10px; border:1px solid var(--border); background:linear-gradient(90deg, #ffffff 25%, #f1f5f9 37%, #ffffff 63%); background-size:400% 100%; animation:shimmer 1.2s infinite; }
  @keyframes shimmer{ 0%{background-position:100% 0} 100%{background-position:0 0} }
  .loader{ margin-top:10px; text-align:center; color:var(--muted); font-size:14px; }
  .uploader{ display:none; margin-top:10px; text-align:center; }
  .uploader.show{ display:block; }
</style>
</head>
<body>
  <div class="wrap">
    <h1><span aria-hidden="true">ðŸ§ </span> NeuroConnections</h1>
    <h2>Create four groups of four!</h2>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <div id="grid" class="grid" aria-label="Tiles grid"></div>
    <div id="loader" class="loader"></div>

    <div id="uploader" class="uploader">
      <input id="fileInput" type="file" accept=".csv,text/csv" />
      <div style="margin-top:8px; color:#64748b; font-size:12px">Tip: Use this when opening the file directly (file://) where browsers block fetching local CSVs.</div>
    </div>

    <div class="controls">
      <button id="shuffle" class="btn" type="button">Shuffle</button>
      <button id="deselect" class="btn" type="button">Deselect All</button>
      <button id="submit" class="btn" type="button">Submit</button>
    </div>

    <footer>created by micah etter, md and sean lee, md</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  const COLORS = ["#B388EB","#5DD0C2","#F2C14E","#F78C6C"];
  const gridEl = document.getElementById("grid");
  const submitEl = document.getElementById("submit");
  const deselectEl = document.getElementById("deselect");
  const shuffleEl = document.getElementById("shuffle");
  const loaderEl = document.getElementById("loader");
  const uploaderEl = document.getElementById("uploader");
  const fileInput = document.getElementById("fileInput");

  function phoenixISODate(now=new Date()){
    const fmt=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Phoenix",year:"numeric",month:"2-digit",day:"2-digit"});
    const p=fmt.formatToParts(now);
    const y=p.find(x=>x.type==="year").value, m=p.find(x=>x.type==="month").value, d=p.find(x=>x.type==="day").value;
    return `${y}-${m}-${d}`;
  }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
  function rgba(hex,alpha=.15){ const s=hex.replace("#",""); const x=s.length===3? s.split("").map(c=>c+c).join(""):s; const n=parseInt(x,16); const r=(n>>16)&255,g=(n>>8)&255,b=n&255; return `rgba(${r},${g},${b},${alpha})`; }
  function showToast(msg,kind){ const t=document.getElementById("toast"); t.textContent=msg; t.className="toast show "+(kind||""); if(kind!=="err"){ clearTimeout(showToast._t); showToast._t=setTimeout(()=>{ t.className="toast"; },1500);} }

  async function loadPuzzlesHttp(){
    loaderEl.textContent = "Loading puzzles.csvâ€¦";
    const res = await fetch("puzzles.csv", {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text = await res.text();
    return parseCsv(text);
  }
  function parseCsv(text){
    const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
    const rows = parsed.data.map(r=>{
      const out={}; Object.keys(r).forEach(k=> out[k.trim().toLowerCase()] = String(r[k]??"").trim()); return out;
    });
    return rowsToPuzzles(rows);
  }
  function rowsToPuzzles(rows){
    const byDate=new Map();
    rows.forEach(r=>{
      const date=r["date"]||""; const category=r["category"];
      const items=[r["item1"],r["item2"],r["item3"],r["item4"]].filter(Boolean);
      if(!date||!category||items.length!==4) return;
      if(!byDate.has(date)) byDate.set(date,[]);
      byDate.get(date).push({name:category, items});
    });
    const dates=[...byDate.keys()].sort();
    return dates.map(d=>({ title:d, categories: byDate.get(d).map((c,i)=>({...c,color:COLORS[i%COLORS.length]})) }));
  }

  let PUZZLES=[], PUZZLE=null, solved=[], selected=new Set(), remaining=new Set(), order=[], itemToCat=new Map();

  function initBoard(){
    solved=[]; selected.clear();
    remaining = new Set(PUZZLE.categories.flatMap(c=>c.items));
    order = shuffle([...remaining]);
    itemToCat = new Map();
    PUZZLE.categories.forEach((c, idx)=> c.items.forEach(it=> itemToCat.set(it, idx)));
    loaderEl.textContent = "";
    render();
  }
  function pickTodayPuzzle(){
    const today=phoenixISODate();
    let idx = PUZZLES.findIndex(p=>p.title===today);
    if(idx<0){ const dayNum=Math.floor(Date.now()/86400000); idx = dayNum % PUZZLES.length; }
    return PUZZLES[idx];
  }
  function getUnsolvedOrder(){ return order.filter(it=>remaining.has(it)); }
  function render(){
    gridEl.innerHTML="";
    solved.forEach(g=>{
      const card=document.createElement("div"); card.className="solved-card"; card.style.background=rgba(g.color,.15); card.style.borderColor=g.color;
      const badge=document.createElement("span"); badge.className="badge"; badge.style.background=g.color; badge.textContent=g.name;
      const items=document.createElement("div"); items.style.opacity=".95"; items.style.fontWeight="700"; items.textContent=g.items.join(" â€¢ ");
      card.appendChild(badge); card.appendChild(items); gridEl.appendChild(card);
    });
    getUnsolvedOrder().forEach(it=>{
      const b=document.createElement("button"); b.type="button"; b.className="tile"; b.textContent=it;
      const isSel=selected.has(it); if(isSel) b.classList.add("selected");
      b.setAttribute("aria-pressed", isSel? "true":"false");
      b.onclick=()=>toggle(it); gridEl.appendChild(b);
    });
    const done = PUZZLE && solved.length===PUZZLE.categories.length;
    [submitEl,deselectEl,shuffleEl].forEach(btn=> btn.disabled = !!done);
  }
  function toggle(it){
    if(!remaining.has(it)) return;
    if(selected.has(it)) selected.delete(it); else { if(selected.size===4) selected.delete([...selected][0]); selected.add(it); }
    [...gridEl.querySelectorAll(".tile")].forEach(btn=>{
      const isSel = selected.has(btn.textContent); btn.classList.toggle("selected", isSel); btn.setAttribute("aria-pressed", isSel? "true":"false");
    });
  }
  function countOverlap(arr, group){ const set=new Set(group); return arr.reduce((n,x)=> n+(set.has(x)?1:0),0); }
  function onSubmit(){
    if(!PUZZLE) return;
    if(selected.size!==4){ showToast("Select 4 tiles.","warn"); return; }
    const sel=[...selected]; const catIdx=itemToCat.get(sel[0]);
    const allSame = sel.every(it=> itemToCat.get(it)===catIdx);
    if(allSame){
      const cat=PUZZLE.categories[catIdx];
      solved.push({name:cat.name, color:cat.color, items:cat.items.slice()});
      sel.forEach(it=> remaining.delete(it)); selected.clear();
      showToast("Correct!","ok"); if(solved.length===PUZZLE.categories.length){ showToast("You solved NeuroConnections!","ok"); } render();
    }else{
      const oneAway = PUZZLE.categories.some(cat=> countOverlap(sel, cat.items)===3);
      showToast(oneAway? "One away!":"Nope. Try again.", oneAway? "warn":"err");
    }
  }
  function onShuffle(){ order = shuffle(getUnsolvedOrder()); render(); }
  function onDeselect(){ selected.clear(); [...gridEl.querySelectorAll(".tile")].forEach(btn=>{ btn.classList.remove("selected"); btn.setAttribute("aria-pressed","false"); }); }

  submitEl.addEventListener("click", onSubmit);
  shuffleEl.addEventListener("click", onShuffle);
  deselectEl.addEventListener("click", onDeselect);

  // Boot: try HTTP fetch; if it fails (common with file://), show uploader fallback
  (async function boot(){
    try{
      PUZZLES = await loadPuzzlesHttp();
      if(!PUZZLES.length) throw new Error("No valid puzzles found");
      PUZZLE = pickTodayPuzzle(); initBoard();
    }catch(e){
      console.warn("HTTP load failed; enabling local CSV uploader.", e);
      loaderEl.textContent = "Couldn't fetch puzzles.csv. Load it manually:";
      uploaderEl.classList.add("show");
    }
  })();

  // Local CSV uploader fallback
  fileInput.addEventListener("change", (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        PUZZLES = parseCsv(String(reader.result));
        if(!PUZZLES.length) throw new Error("No valid puzzles in CSV");
        PUZZLE = pickTodayPuzzle(); uploaderEl.classList.remove("show"); initBoard();
      }catch(err){
        console.error(err); showToast("Invalid CSV format.","err");
      }
    };
    reader.readAsText(file);
  });
  </script>
</body>
</html>
